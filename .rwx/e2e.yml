on:
  dispatch:
    - key: gastown-e2e
      init:
        commit-sha: ${{ event.git.sha }}
        namespace: ${{ event.dispatch.params.namespace }}
        keep: ${{ event.dispatch.params.keep }}
        only: ${{ event.dispatch.params.only }}
        skip: ${{ event.dispatch.params.skip }}
      params:
        - key: namespace
          name: K8s namespace
          description: K8s namespace (leave empty for ephemeral)
          default: ""
          required: false
        - key: keep
          name: Keep namespace
          description: Keep namespace after tests (for debugging)
          default: "false"
          required: false
        - key: only
          name: Only module
          description: Run only this test module (e.g. daemon-health)
          default: ""
          required: false
        - key: skip
          name: Skip modules
          description: Comma-separated modules to skip
          default: ""
          required: false
      title: E2E Tests
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      namespace: ""
      keep: "false"
      only: ""
      skip: ""

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: system-deps
    run: |
      sudo apt-get update
      sudo apt-get install -y curl unzip

  - key: code
    use: system-deps
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gastown.git
      ref: ${{ init.commit-sha }}

  - key: aws-cli
    run: |
      curl -sSf "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip
      unzip -q /tmp/awscliv2.zip -d /tmp
      sudo /tmp/aws/install
      aws --version

  - key: helm-setup
    run: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  - key: kubectl-setup
    run: |
      KUBE_VERSION=$(curl -sSfL https://dl.k8s.io/release/stable.txt)
      echo "Installing kubectl $KUBE_VERSION"
      curl -sSfL "https://dl.k8s.io/release/${KUBE_VERSION}/bin/linux/amd64/kubectl" -o /tmp/kubectl
      sudo install /tmp/kubectl /usr/local/bin/kubectl
      kubectl version --client

  - key: kubeconfig
    use: [aws-cli, kubectl-setup]
    run: |
      aws eks update-kubeconfig --name "$EKS_CLUSTER" --region us-east-1
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.E2E_AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.E2E_AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
      EKS_CLUSTER: ${{ secrets.E2E_EKS_CLUSTER }}

  - key: helm-deps
    use: [code, helm-setup, kubeconfig]
    run: |
      echo "$GHCR_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USER" --password-stdin
      helm dependency build helm/gastown/
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  - key: e2e
    use: helm-deps
    timeout: 30m
    run: |
      ARGS=()
      if [ -n "$NAMESPACE" ]; then
        ARGS+=("--namespace" "$NAMESPACE")
      fi
      if [ "$KEEP" = "true" ]; then
        ARGS+=("--keep")
      fi
      if [ -n "$ONLY" ]; then
        ARGS+=("--only" "$ONLY")
      fi
      if [ -n "$SKIP" ]; then
        IFS=',' read -ra SKIP_MODULES <<< "$SKIP"
        for mod in "${SKIP_MODULES[@]}"; do
          ARGS+=("--skip" "$(echo "$mod" | xargs)")
        done
      fi
      ARGS+=("--json")
      ARGS+=("--junit-dir" "/tmp/junit-results")
      ARGS+=("--set" "bd-daemon.externalSecrets.doltRootPassword.remoteRef=$DOLT_ROOT_PASSWORD_REF")
      ARGS+=("--set" "bd-daemon.externalSecrets.daemonToken.remoteRef=$DAEMON_TOKEN_REF")
      ARGS+=("--set" "bd-daemon.externalSecrets.doltS3Credentials.remoteRef=$DOLT_S3_CREDENTIALS_REF")

      ./tests/e2e/scripts/e2e-formula.sh "${ARGS[@]}"
    env:
      NAMESPACE: ${{ init.namespace }}
      KEEP: ${{ init.keep }}
      ONLY: ${{ init.only }}
      SKIP: ${{ init.skip }}
      DOLT_ROOT_PASSWORD_REF: ${{ secrets.E2E_DOLT_ROOT_PASSWORD_REF }}
      DAEMON_TOKEN_REF: ${{ secrets.E2E_DAEMON_TOKEN_REF }}
      DOLT_S3_CREDENTIALS_REF: ${{ secrets.E2E_DOLT_S3_CREDENTIALS_REF }}
      AWS_ACCESS_KEY_ID: ${{ secrets.E2E_AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.E2E_AWS_SECRET_ACCESS_KEY }}
      AWS_DEFAULT_REGION: us-east-1
    outputs:
      artifacts:
        - key: junit-results
          path: /tmp/junit-results
