on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
      status-checks:
        name: Helm
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
      status-checks:
        name: Helm
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gastown.git
      ref: ${{ init.commit-sha }}

  - key: helm-setup
    run: curl -fsSL https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

  - key: helm-login
    use: helm-setup
    run: |
      echo "$GHCR_TOKEN" | helm registry login ghcr.io -u "$GITHUB_USER" --password-stdin
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}

  - key: helm-lint
    use: [code, helm-login]
    run: |
      for chart in helm/*/; do
        if [ -f "$chart/Chart.yaml" ]; then
          echo "=== Linting $chart ==="
          # Build deps first (gastown chart depends on bd-daemon from GHCR)
          helm dependency build "$chart" 2>/dev/null || true
          helm lint "$chart"
          helm template "$(basename $chart)" "$chart" > /dev/null
        fi
      done

  - key: helm-publish
    use: helm-lint
    if: ${{ init.ref-name != 'pr' }}
    run: |
      for chart in helm/*/; do
        if [ -f "$chart/Chart.yaml" ]; then
          name=$(basename "$chart")
          version=$(grep '^version:' "$chart/Chart.yaml" | awk '{print $2}')
          echo "Publishing $name v$version..."
          helm dependency build "$chart"
          helm package "$chart" --destination /tmp/helm-packages
          helm push "/tmp/helm-packages/${name}-${version}.tgz" "oci://ghcr.io/groblegark/charts"
          echo "Published: oci://ghcr.io/groblegark/charts/${name}:${version}"
        fi
      done
    env:
      GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
      GITHUB_USER: ${{ secrets.GITHUB_USER }}
