on:
  github:
    push:
      if: ${{ starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        tag: ${{ event.git.tag }}
      status-checks:
        name: Release
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      tag: dev

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gastown.git
      ref: ${{ init.commit-sha }}

  - key: go
    use: code
    call: golang/install 1.2.0
    with:
      go-version: "1.25"

  - key: goreleaser
    use: go
    run: |
      # Install GoReleaser
      curl -sSfL https://github.com/goreleaser/goreleaser/releases/download/v2.8.2/goreleaser_Linux_x86_64.tar.gz \
        | sudo tar xz -C /usr/local/bin goreleaser

      # Need full git history for GoReleaser changelog
      git fetch --unshallow 2>/dev/null || true
      git fetch --tags

      # Run GoReleaser
      GITHUB_TOKEN="$GH_TOKEN" goreleaser release --clean --config .goreleaser.fork.yml
    env:
      GH_TOKEN: ${{ secrets.GH_TOKEN }}
