# CI — manual only (no auto-trigger on push/PR).
# Run manually: rwx run .rwx/ci.yml --init commit-sha=$(git rev-parse HEAD) --wait
on:
  cli:
    init:
      commit-sha: ${{ event.git.sha }}

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ── Clone ──────────────────────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gastown.git
      ref: ${{ init.commit-sha }}

  # ── Go toolchain (version from .go-version) ──────────────────────────
  - key: go
    call: golang/install 1.2.0
    with:
      go-version: "1.25"

  # ── Download modules (cached by go.mod/go.sum) ────────────────────────
  - key: go-deps
    use: [code, go]
    run: go mod download
    filter:
      - go.mod
      - go.sum

  # ── Git config (needed for tests) ─────────────────────────────────────
  - key: git-config
    use: go-deps
    run: |
      git config --global user.name "CI Bot"
      git config --global user.email "ci@gastown.test"

  # ── Build ─────────────────────────────────────────────────────────────
  - key: build
    use: git-config
    run: go build -v ./cmd/gt

  # ── Check embedded formulas (parallel with build) ─────────────────────
  - key: embedded-formulas
    use: git-config
    run: |
      go build -v ./cmd/gt
      go generate ./internal/formula/...
      if ! git diff --exit-code internal/formula/formulas/; then
        echo "ERROR: Committed formulas out of sync"
        echo "Run: go generate ./... && git add -A && git commit"
        exit 1
      fi

  # ── Lint (parallel with build) ────────────────────────────────────────
  - key: lint
    use: git-config
    run: |
      go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@v2.10.1
      golangci-lint run --timeout=5m
    filter:
      - .golangci.yml

  # ── Test ──────────────────────────────────────────────────────────────
  - key: test
    use: build
    run: go test -race -short -coverprofile=coverage.out ./...

  # ── Integration tests ────────────────────────────────────────────────
  - key: integration
    use: build
    run: |
      go install github.com/steveyegge/beads/cmd/bd@v0.47.1
      export PATH="$(go env GOPATH)/bin:$PATH"
      go test -tags=integration -timeout=5m -v ./internal/cmd/...
    filter:
      - go.mod
      - go.sum

  # ── Beads JSONL change guard ──────────────────────────────────────────
  - key: beads-changes-check
    use: code
    run: |
      git fetch origin main 2>/dev/null || true
      if git diff --name-only origin/main...HEAD 2>/dev/null | grep -q "^\.beads/issues\.jsonl$"; then
        echo "ERROR: .beads/issues.jsonl modified — not allowed in PRs"
        exit 1
      fi
      echo "No .beads/issues.jsonl changes"
