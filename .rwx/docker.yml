# OCI image builds for gastown services — RWX native (no Dockerfiles).
#
# Uses $RWX_IMAGE for image metadata instead of inline Dockerfiles.
# Images are pushed via `rwx image build --push-to` from the CLI,
# The build VM uses rwx/base 1.0.0; the $RWX_IMAGE output defines
# the final container filesystem and metadata.
#
# Architecture:
#   build-* tasks → compile binaries as artifacts (cached by filters)
#   image-*  tasks → install runtime deps + configure $RWX_IMAGE metadata
#   Push is handled by rwx image build --target <task> --push-to <registry>
#
# OPTIMIZATIONS:
# - Filter directives on Go mod downloads (cached by go.mod/go.sum)
# - Parallel builds with filter caching for dependency stability
# - RWX native layer caching replaces Docker BuildKit

on:
  github:
    push:
      if: ${{ event.git.branch == 'main' || starts-with(event.git.tag, 'v') }}
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.git.ref }}
        coop-version: latest
      status-checks:
        name: Docker
    pull_request:
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: pr
        coop-version: latest
      status-checks:
        - tasks: [build-gt, build-controller, download-coop, download-bd]
          name: Docker
  dispatch:
    - key: gastown-agent-rebuild
      init:
        commit-sha: ${{ event.git.sha }}
        ref-name: ${{ event.dispatch.params.trigger-source }}
        coop-version: ${{ event.dispatch.params.coop-version }}
      params:
        - key: trigger-source
          name: Trigger source
          description: What triggered the rebuild (e.g. coop-release, beads-release)
          default: manual
          required: false
        - key: coop-version
          name: Coop version
          description: Coop release tag to pin (e.g. v0.11.20). Defaults to latest.
          default: latest
          required: false
      title: Agent rebuild (${{ init.ref-name }})
      target: image-agent
  cli:
    init:
      commit-sha: ${{ event.git.sha }}
      ref-name: cli
      coop-version: latest

base:
  image: ubuntu:24.04
  config: rwx/base 1.0.0

tasks:
  # ═══════════════════════════════════════════════════════════════════════
  # Build tasks — compile and download in parallel, output binary artifacts
  # ═══════════════════════════════════════════════════════════════════════

  # ── Clone gastown repo ─────────────────────────────────────────────
  - key: code
    call: git/clone 2.0.3
    with:
      repository: https://github.com/groblegark/gastown.git
      ref: ${{ init.commit-sha }}

  # ── Go toolchain (version from .go-version) ───────────────────────
  - key: go
    call: golang/install 1.2.0
    with:
      go-version: "1.25"

  # ── Go mod download (cached by go.mod/go.sum) ──────────────────────
  - key: go-deps
    use: [code, go]
    run: go mod download
    filter:
      - go.mod
      - go.sum

  # ── Build gt CLI binary → artifact ──────────────────────────────────
  - key: build-gt
    use: go-deps
    run: |
      REF_NAME="${REF_NAME#refs/tags/}"
      REF_NAME="${REF_NAME#refs/heads/}"
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w \
          -X github.com/steveyegge/gastown/internal/cmd.Version=${REF_NAME} \
          -X github.com/steveyegge/gastown/internal/cmd.Commit=${COMMIT_SHA} \
          -X github.com/steveyegge/gastown/internal/cmd.BuildTime=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
          -X github.com/steveyegge/gastown/internal/cmd.BuiltProperly=1" \
        -o gt ./cmd/gt
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    outputs:
      artifacts:
        - key: gt-binary
          path: gt

  # ── Build controller binary → artifact (separate Go module) ─────────
  - key: build-controller
    use: [code, go]
    run: |
      cd controller
      go mod download
      CGO_ENABLED=0 GOOS=linux go build \
        -ldflags="-s -w -X main.version=${REF_NAME} -X main.commit=${COMMIT_SHA}" \
        -o ../controller-bin ./cmd/controller/
    env:
      COMMIT_SHA: ${{ init.commit-sha }}
      REF_NAME: ${{ init.ref-name }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    outputs:
      artifacts:
        - key: controller-binary
          path: controller-bin

  # ── Download coop from releases → artifact (parallel, cached monthly) ─
  - key: download-coop
    run: |
      set -ex
      COOP_VER="${COOP_VERSION:-latest}"
      if [ "$COOP_VER" = "latest" ] || [ -z "$COOP_VER" ]; then
        COOP_VER=$(curl -fsSL https://api.github.com/repos/groblegark/coop/releases/latest | jq -r .tag_name)
      fi
      echo "Downloading coop ${COOP_VER} for linux-amd64"
      curl -fsSL "https://github.com/groblegark/coop/releases/download/${COOP_VER}/coop-linux-amd64.tar.gz" \
        -o /tmp/coop.tar.gz
      mkdir -p coop-bin
      tar -xzf /tmp/coop.tar.gz -C coop-bin
      ls -la coop-bin/
    env:
      COOP_VERSION: ${{ init.coop-version }}
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: coop-binaries
          path: coop-bin

  # ── Download bd from releases → artifact (parallel, cached monthly) ──
  - key: download-bd
    run: |
      set -ex
      BD_VERSION=$(curl -fsSL https://api.github.com/repos/groblegark/beads/releases/latest | jq -r .tag_name)
      VERSION_NUM=${BD_VERSION#v}
      echo "Downloading bd ${BD_VERSION} for linux_amd64"
      curl -fsSL "https://github.com/groblegark/beads/releases/download/${BD_VERSION}/beads_${VERSION_NUM}_linux_amd64.tar.gz" \
        -o /tmp/bd.tar.gz
      mkdir -p bd-bin
      tar -xzf /tmp/bd.tar.gz -C bd-bin
      ls -la bd-bin/
    filter:
      - .rwx/cache-config.lock
    outputs:
      artifacts:
        - key: bd-binaries
          path: bd-bin

  # ═══════════════════════════════════════════════════════════════════════
  # Image tasks — RWX native images via $RWX_IMAGE.
  # These define the container filesystem and metadata.
  # Push via: rwx image build -f .rwx/docker.yml --target <key> --push-to <ref>
  # ═══════════════════════════════════════════════════════════════════════

  # ── gt CLI image (alpine + git + binary) ───────────────────────────
  - key: image-gt
    use: [build-gt]
    if: ${{ init.ref-name != 'pr' }}
    filter:
      - cmd/gt/**/*.go
      - internal/**/*.go
      - go.mod
      - go.sum
    run: |
      # Install minimal runtime deps
      sudo apt-get -y update
      sudo apt-get -y install --no-install-recommends ca-certificates git
      sudo apt-get clean
      sudo rm -rf /var/lib/apt/lists/*

      # Install binary
      sudo cp ${{ tasks.build-gt.artifacts.gt-binary }} /usr/local/bin/gt
      sudo chmod 755 /usr/local/bin/gt

      # Configure image metadata (no sudo needed)
      jq -n '["gt"]' > $RWX_IMAGE/entrypoint.json
      echo "1000" > $RWX_IMAGE/user

  # ── Controller image (minimal static binary) ───────────────────────
  - key: image-controller
    use: [build-controller]
    if: ${{ init.ref-name != 'pr' }}
    filter:
      - controller/**/*.go
      - controller/go.mod
      - controller/go.sum
    run: |
      # Install binary
      sudo cp ${{ tasks.build-controller.artifacts.controller-binary }} /controller
      sudo chmod 755 /controller

      # Configure image metadata
      jq -n '["/controller"]' > $RWX_IMAGE/entrypoint.json
      echo "65534" > $RWX_IMAGE/user

  # ── Agent image (ubuntu + apt packages + gt/coop/bd/claude) ────────
  - key: image-agent
    use: [build-gt, download-coop, download-bd, code]
    if: ${{ init.ref-name != 'pr' }}
    filter:
      - deploy/agent/entrypoint.sh
      - .node-version
    run: |
      # WORKAROUND: Do NOT run apt-get update/install here.
      # On multi-layer overlayfs (4 dependency layers), apt-get update
      # corrupts /etc/shadow visibility, breaking all subsequent sudo calls.
      # The base image (rwx/base 1.0.0) already provides git, curl,
      # ca-certificates, and jq — verified by "0 newly installed" in logs.

      # Install Node.js from binary tarball (version from .node-version)
      NODE_VERSION=$(cat .node-version)
      curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz" \
        | sudo tar -xJ --strip-components=1 -C /usr/local

      # Install binaries
      sudo cp ${{ tasks.build-gt.artifacts.gt-binary }} /usr/local/bin/gt
      sudo cp ${{ tasks.download-coop.artifacts.coop-binaries }}/coop /usr/local/bin/coop
      sudo cp ${{ tasks.download-coop.artifacts.coop-binaries }}/coop-mux /usr/local/bin/coop-mux 2>/dev/null || true
      sudo cp ${{ tasks.download-bd.artifacts.bd-binaries }}/bd /usr/local/bin/bd
      sudo ln -sf /usr/local/bin/coop-mux /usr/local/bin/coopmux
      sudo chmod +x /usr/local/bin/gt /usr/local/bin/coop /usr/local/bin/bd \
        /usr/local/bin/coop-mux 2>/dev/null || true

      # Install entrypoint
      sudo cp deploy/agent/entrypoint.sh /entrypoint.sh
      sudo chmod +x /entrypoint.sh

      # Create home directory while we still have sudo
      sudo mkdir -p /home/agent/gt
      sudo chown -R 1000:1000 /home/agent

      # WORKAROUND: npm install -g and sed both corrupt /etc/shadow on
      # multi-layer overlayfs, breaking subsequent sudo calls. Run them
      # in a single sudo bash -c to avoid re-authentication.
      sudo bash -c '
        npm install -g @anthropic-ai/claude-code
        sed -i "s/^ubuntu:/agent:/" /etc/passwd
        sed -i "s|/home/ubuntu|/home/agent|" /etc/passwd
        sed -i "s/^ubuntu:/agent:/" /etc/group
      '

      # Configure image metadata (no sudo needed)
      jq -n '["/entrypoint.sh"]' > $RWX_IMAGE/entrypoint.json
      echo "agent" > $RWX_IMAGE/user
      echo "/home/agent/gt" > $RWX_IMAGE/workspace

  # ── Toolchain image (Go + Node + Python + AWS/RWX/kubectl + Docker CLI) ──
  - key: image-toolchain
    use: code
    if: ${{ init.ref-name != 'pr' }}
    filter:
      - .rwx/toolchain-version.lock
      - .go-version
      - .node-version
    run: |
      export DEBIAN_FRONTEND=noninteractive

      # Run ALL apt and sudo operations in a single sudo bash -c block.
      # WORKAROUND: dpkg operations (apt-get install) corrupt /etc/shadow
      # on RWX overlayfs, breaking subsequent sudo re-authentication.
      # A single sudo session avoids re-auth after corruption.
      sudo bash -c '
        set -e

        # Base tools
        apt-get -y update
        apt-get -y install --no-install-recommends \
          curl git jq make unzip ca-certificates

        # Go (version from .go-version, installer resolves latest patch)
        GO_VERSION=$(cat .go-version)
        GO_LATEST=$(curl -fsSL "https://go.dev/dl/?mode=json" | jq -r "[.[] | select(.version | startswith(\"go${GO_VERSION}\"))][0].version")
        curl -fsSL "https://go.dev/dl/${GO_LATEST}.linux-amd64.tar.gz" | tar -C /usr/local -xz
        export PATH="/usr/local/go/bin:$PATH"
        GOPATH="/tmp/go" go install golang.org/x/tools/gopls@latest
        mv /tmp/go/bin/gopls /usr/local/go/bin/gopls
        rm -rf /tmp/go

        # Node.js (version from .node-version; binary tarball — nodesource apt triggers shadow corruption)
        NODE_VERSION=$(cat .node-version)
        curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-linux-x64.tar.xz" \
          | tar -xJ --strip-components=1 -C /usr/local

        # Python
        apt-get -y install --no-install-recommends \
          python3 python3-pip python3-venv
        ln -sf /usr/bin/python3 /usr/bin/python

        # AWS CLI
        curl -fsSL "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscli.zip
        unzip -q /tmp/awscli.zip -d /tmp
        /tmp/aws/install --install-dir /opt/aws-cli --bin-dir /opt/aws-cli/bin
        ln -sf /opt/aws-cli/bin/aws /usr/local/bin/aws
        rm -rf /tmp/awscli.zip /tmp/aws

        # Docker CLI (client only)
        curl -fsSL "https://download.docker.com/linux/static/stable/x86_64/docker-27.5.1.tgz" | \
          tar -xz --strip-components=1 -C /usr/local/bin docker/docker

        # Rust Analyzer
        curl -fsSL "https://github.com/rust-lang/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz" | \
          gunzip | tee /usr/local/bin/rust-analyzer > /dev/null
        chmod +x /usr/local/bin/rust-analyzer

        # kubectl
        KUBECTL_VERSION=$(curl -fsSL https://dl.k8s.io/release/stable.txt)
        curl -fsSL "https://dl.k8s.io/release/${KUBECTL_VERSION}/bin/linux/amd64/kubectl" \
          -o /usr/local/bin/kubectl
        chmod +x /usr/local/bin/kubectl

        # RWX CLI
        curl -fsSL "https://github.com/rwx-cloud/cli/releases/latest/download/rwx-linux-x86_64" \
          -o /usr/local/bin/rwx
        chmod +x /usr/local/bin/rwx

        # Clean up
        apt-get clean
        rm -rf /var/lib/apt/lists/*

        # Install entrypoint and create home dir
        cp docker/toolchain/entrypoint.sh /usr/local/bin/toolchain-entrypoint.sh
        chmod +x /usr/local/bin/toolchain-entrypoint.sh
        mkdir -p /home/agent
        chown -R 1000:1000 /home/agent

        # Rename ubuntu→agent in passwd/group (breaks sudo for running process)
        sed -i "s/^ubuntu:/agent:/" /etc/passwd
        sed -i "s|/home/ubuntu|/home/agent|" /etc/passwd
        sed -i "s|/bin/sh|/bin/bash|" /etc/passwd
        sed -i "s/^ubuntu:/agent:/" /etc/group
      '

      # Configure image metadata (no sudo needed)
      echo "/usr/local/bin/toolchain-entrypoint.sh" > $RWX_IMAGE/command
      echo "1000:1000" > $RWX_IMAGE/user
      echo "/home/agent/gt" > $RWX_IMAGE/workspace
