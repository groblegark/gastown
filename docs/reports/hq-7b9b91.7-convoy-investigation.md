# Convoy System Investigation Report

**Bead:** hq-7b9b91.7
**Date:** 2026-01-22
**Status:** Complete

## Summary

Investigation of the Gas Town convoy system to understand its architecture, implementation patterns, and operational characteristics. The convoy system is the primary mechanism for tracking batched work across rigs.

## Findings

### 1. Core Architecture

**Convoys are persistent tracking units** that live in town-level beads (prefix `hq-cv-*`) and can track issues across any rig.

```
Town (.beads/)
  └── hq-cv-xyz (convoy)
       ├── tracks: gt-abc (gastown issue)
       ├── tracks: bd-def (beads issue)
       └── tracks: gt-ghi (gastown issue)
```

**Key files:**
- `internal/convoy/observer.go` - Shared observer operations (137 lines)
- `internal/daemon/convoy_watcher.go` - Event-driven completion (252 lines)
- `internal/cmd/convoy.go` - CLI implementation (1738 lines)

### 2. Event-Driven Completion

The system uses **event-driven convoy completion** rather than pure polling:

1. **ConvoyWatcher** (daemon) monitors `bd activity --follow --town --json`
2. When an issue closes (`status=closed`), it checks if tracked by any convoy
3. If all tracked issues are closed, it runs `gt convoy check <convoy-id>`
4. The check closes the convoy and sends notifications

**Redundant observers** ensure convoys close even if one observer is down:
| Observer | Trigger | Scope |
|----------|---------|-------|
| Daemon (ConvoyWatcher) | bd activity event | All convoys |
| Witness | After polecat verification | Rig's convoy work |
| Deacon | Periodic patrol | All convoys (backup) |

### 3. Cross-Rig Tracking

Convoys handle cross-rig dependencies via **external references**:

```
Format: external:rig:issue-id
Example: external:gastown:gt-abc
```

The `formatTrackBeadID()` function converts issue IDs to external references when tracking issues from different rigs.

### 4. Stranded Convoy Detection

A convoy is "stranded" when:
- Status is open
- Has tracked issues where:
  - status = open (not in_progress, not closed)
  - not blocked
  - no assignee OR assignee session is dead

`gt convoy stranded` finds these and suggests feeding commands.

### 5. Backend Support

The convoy system supports **both SQLite and Dolt** backends:

- `newBdCmd()` sets `BEADS_DIR` environment variable for bd commands
- `getWorkersForIssues()` uses `beads.RunQuery()` for backend-agnostic queries
- `getTrackingConvoys()` in convoy_watcher uses `bd` CLI rather than direct sqlite3

### 6. Notification System

Completion notifications are parsed from convoy description:
```
Owner: mayor/          <- Gets completion notification
Notify: ops/           <- Additional subscriber
```

`notifyConvoyCompletion()` parses these and sends mail via `gt mail send`.

### 7. Commands Implemented

| Command | Purpose |
|---------|---------|
| `gt convoy create` | Create convoy tracking issues |
| `gt convoy add` | Add issues to existing convoy |
| `gt convoy status` | Show convoy progress |
| `gt convoy list` | List convoys (dashboard) |
| `gt convoy check` | Check/auto-close completed convoys |
| `gt convoy close` | Manually close a convoy |
| `gt convoy stranded` | Find convoys needing workers |
| `gt convoy -i` | Interactive TUI |

### 8. Performance Optimizations

Recent improvements include:
- **Batched issue lookup**: `getIssueDetailsBatch()` fetches multiple issues in one `bd show` call
- **Parallel rig queries**: `getWorkersForIssues()` queries all rigs concurrently
- **JSONL parsing**: `getConvoyDependenciesFromJSONL()` avoids sqlite3 dependency

## Recommendations

### Implemented (no action needed)
1. Event-driven completion via ConvoyWatcher
2. Redundant observers (Witness, Refinery, Deacon)
3. Manual close command (`gt convoy close`)
4. Owner field for targeted notifications
5. Dolt backend support

### Future Considerations
1. **Timeout/SLA support**: Add `--due` flag for deadline tracking (mentioned in design doc)
2. **ABANDONED state**: Differentiate force-closed from completed convoys
3. **`gt convoy reopen`**: Explicit reopen command (currently implicit via add)

## Errors Encountered

1. **Bead not found**: The original bead `hq-7b9b91.7` could not be resolved via `bd show`. This may indicate the bead was created in a previous session context that was cleared.

2. **No mail context**: No handoff mail was found in the inbox. The investigation proceeded by examining the convoy codebase directly.

## Conclusion

The convoy system is mature and well-designed, implementing the key principles from the design document:
- Event-driven rather than poll-based
- Redundantly observed for resilience
- Cross-rig capable
- Notification-enabled

The implementation aligns with Gas Town's "steam engine" metaphor - convoys provide the tracking infrastructure while polecats are the pistons doing the work.
