# Gas Town Slack Bot Setup Guide

## Overview

The Gas Town Slack bot (`gt slack start`) allows team members to view and resolve pending decisions directly from Slack without SSH access to the town.

## Prerequisites

1. **gtmobile server running** on accessible endpoint (default: `http://localhost:8443`)
2. **Slack workspace** with admin access to create apps
3. **Go 1.21+** for building the gt binary

## Slack App Configuration

### Step 1: Create Slack App

1. Go to [api.slack.com/apps](https://api.slack.com/apps)
2. Click "Create New App" → "From scratch"
3. Name: "Gas Town Decisions" (or your preference)
4. Select your workspace
5. Click "Create App"

### Step 2: Enable Socket Mode

1. In app settings, go to "Socket Mode"
2. Toggle "Enable Socket Mode" ON
3. Create an App-Level Token:
   - Token Name: "socket-mode"
   - Scopes: `connections:write`
4. Click "Generate"
5. **Save the token** (starts with `xapp-`) - this is your `SLACK_APP_TOKEN`

### Step 3: Configure Bot Token Scopes

1. Go to "OAuth & Permissions"
2. Under "Scopes" → "Bot Token Scopes", add:
   - `chat:write` - Post messages
   - `commands` - Handle slash commands
   - `users:read` - Get user info
   - `channels:read` - List channels
   - `channels:join` - Join channels

**For dynamic channel creation** (optional, enables `--dynamic-channels` flag):
   - `channels:manage` - Create new public channels

### Step 4: Create Slash Command

1. Go to "Slash Commands"
2. Click "Create New Command"
3. Configure:
   - Command: `/decisions`
   - Description: "List pending Gas Town decisions"
   - Usage Hint: (leave empty)
4. Click "Save"

### Step 5: Enable Interactivity

1. Go to "Interactivity & Shortcuts"
2. Toggle "Interactivity" ON
3. Request URL can be left empty (Socket Mode handles this)
4. Click "Save Changes"

### Step 6: Install App to Workspace

1. Go to "Install App"
2. Click "Install to Workspace"
3. Review permissions and click "Allow"
4. **Save the Bot Token** (starts with `xoxb-`) - this is your `SLACK_BOT_TOKEN`

### Step 7: Get Channel ID (for notifications)

1. In Slack, right-click the channel for notifications
2. Click "View channel details"
3. At the bottom, copy the Channel ID (starts with `C`)

## Running the Bot

### Build

```bash
cd /path/to/gastown
make install  # Installs gt binary to ~/.local/bin/
```

### Run with Flags

```bash
gt slack start \
  --bot-token=xoxb-your-token \
  --app-token=xapp-your-token \
  --channel=C0123456789 \
  --rpc=http://localhost:8443
```

### Run with Environment Variables

```bash
export SLACK_BOT_TOKEN=xoxb-your-token
export SLACK_APP_TOKEN=xapp-your-token
export SLACK_CHANNEL=C0123456789
export GTMOBILE_RPC=http://localhost:8443

gt slack start
```

### Verify Connection

You should see:
```
Starting Gas Town Slack bot
RPC endpoint: http://localhost:8443
Notifications channel: C0123456789
Starting SSE listener: http://localhost:8443/events/decisions
Slack: Connecting to Socket Mode...
Slack: Connected to Socket Mode
SSE: Connected to decision events stream
```

## Architecture

```
┌─────────────┐     Socket Mode      ┌─────────────┐
│   Slack     │◄────────────────────►│ gt slack    │
│  Workspace  │     (WebSocket)      │    bot      │
└─────────────┘                      └──────┬──────┘
                                            │
                              ┌─────────────┴─────────────┐
                              │                           │
                              ▼                           ▼
                     ┌─────────────┐             ┌─────────────┐
                     │  gtmobile   │◄────────────│     SSE     │
                     │  RPC API    │   /events   │  Listener   │
                     └─────────────┘             └─────────────┘
```

## Health Endpoints (for Kubernetes)

The Slack bot provides HTTP health endpoints for Kubernetes probes:

```bash
gt slack start --health-port=8080  # default port
```

Endpoints:
- `/healthz` - Liveness probe (returns 503 if disconnected from Slack)
- `/readyz` - Readiness probe (always returns 200 once started)

Environment variable: `HEALTH_PORT=8080`

## Features

| Command/Action | Description |
|---------------|-------------|
| `/decisions` | List all pending decisions with urgency indicators |
| "View" button | Show decision details with resolve options |
| Option buttons | Open modal to enter rationale |
| Modal submit | Resolve decision via RPC |
| SSE notifications | Auto-post new decisions to channel |

## Troubleshooting

### "Invalid token" error
- Verify bot token starts with `xoxb-`
- Verify app token starts with `xapp-`
- Check tokens are not expired

### "Connection error" in SSE
- Verify gtmobile is running: `curl http://localhost:8443/health`
- Check RPC endpoint URL is correct
- Verify firewall allows connection

### Bot not responding to commands
- Verify Socket Mode is enabled in Slack app
- Check bot is installed to workspace
- Verify slash command is configured

### Decisions not appearing
- Check gtmobile has pending decisions: `curl -X POST http://localhost:8443/gastown.v1.DecisionService/ListPending -H "Content-Type: application/json" -d "{}"`
- Verify bot has `chat:write` scope

### Modal not opening
- Check interactivity is enabled in Slack app
- Verify trigger ID is being received (enable debug mode)

## Channel Routing Configuration

The Slack bot supports per-agent channel routing via a `slack.json` configuration file. This enables the "Break Out" feature, which creates dedicated channels for specific agents.

### Configuration File Location

The bot looks for `slack.json` in these locations (in order):

1. `$GT_ROOT/settings/slack.json`
2. `~/gt/settings/slack.json`
3. `<town-root>/settings/slack.json`

### Minimal Configuration (for Break Out)

To enable the Break Out feature, create a minimal `slack.json`:

```bash
mkdir -p ~/gt/settings
cat > ~/gt/settings/slack.json << 'EOF'
{
  "type": "slack",
  "version": 1,
  "enabled": true,
  "default_channel": "C0123456789"
}
EOF
```

Replace `C0123456789` with your notifications channel ID.

### Full Configuration (per-agent routing)

For advanced channel routing, see the example at `docs/examples/slack.json.example`:

```json
{
  "type": "slack",
  "version": 1,
  "enabled": true,
  "default_channel": "C0123456789",
  "channels": {
    "gastown/polecats/*": "C_GASTOWN_POLECATS",
    "gastown/crew/*": "C_GASTOWN_CREW",
    "*/polecats/*": "C_ALL_POLECATS"
  }
}
```

Pattern matching:
- `*` matches any single path segment
- More specific patterns take precedence
- Patterns without wildcards match exactly

### Break Out Feature

The "Break Out" button appears on decision notifications when:
1. The `slack.json` config exists and is valid
2. The bot has `channels:manage` scope (for creating channels)

When clicked, Break Out:
1. Creates a dedicated channel for the agent (e.g., `#gt-decisions-gastown-crew-wolf`)
2. Routes future decisions from that agent to the new channel
3. Reposts any pending decisions to the new channel

Overrides created by Break Out are saved to `slack.json` in the `overrides` field.

### Troubleshooting Channel Routing

**"Break Out is not available: channel router not configured"**
- Create `slack.json` in one of the locations listed above
- Verify the file contains valid JSON with `enabled: true`

**Break Out button not appearing**
- The button only shows when the decision has a `requested_by` field
- Check that the router is loaded: look for "Channel router auto-loaded" in logs

## Debug Mode

Run with `--debug` for verbose logging:

```bash
gt slack start --debug --bot-token=... --app-token=...
```

## Systemd Service

For production deployments, use the systemd service:

```bash
systemctl --user enable gt-slack
systemctl --user start gt-slack
journalctl --user -u gt-slack -f  # View logs
```

See `docs/systemd/gt-slack.service` for the service configuration.
