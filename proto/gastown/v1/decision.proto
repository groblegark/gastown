syntax = "proto3";

package gastown.v1;

option go_package = "github.com/steveyegge/gastown/mobile/gen/gastown/v1;gastownv1";

import "google/protobuf/timestamp.proto";
import "gastown/v1/common.proto";

// DecisionService handles human-in-the-loop decision points.
//
// Agents create decisions when they need human/captain input — typically at
// session boundaries via the stop hook. The decision contains a question,
// available options, and context. A human or captain agent resolves the
// decision by choosing an option with a rationale.
//
// Decision lifecycle: created → (pending) → resolved | cancelled
//
// Decisions support chaining (predecessor_id) and hierarchy (parent_bead)
// for complex multi-step workflows.
service DecisionService {
  // ListPending returns all unresolved, uncancelled decisions.
  // Filter by minimum urgency or requesting agent.
  rpc ListPending(ListPendingRequest) returns (ListPendingResponse);

  // GetDecision returns full details for a specific decision by ID.
  rpc GetDecision(GetDecisionRequest) returns (GetDecisionResponse);

  // CreateDecision creates a new decision request and emits a
  // DECISION_REQUESTED event to the activity bus for real-time notification.
  rpc CreateDecision(CreateDecisionRequest) returns (CreateDecisionResponse);

  // Resolve resolves a pending decision by selecting an option (1-indexed)
  // and providing a rationale. Emits a DECISION_RESOLVED event and
  // delivers the response to the requesting agent's inbox.
  rpc Resolve(ResolveRequest) returns (ResolveResponse);

  // Cancel cancels a pending decision with a reason.
  rpc Cancel(CancelRequest) returns (CancelResponse);

  // WatchDecisions streams new pending decisions in real-time.
  // Filter by minimum urgency level.
  rpc WatchDecisions(WatchDecisionsRequest) returns (stream Decision);
}

message ListPendingRequest {
  Urgency min_urgency = 1;  // Filter by minimum urgency
  string requested_by = 2;  // Filter by requesting agent
}

message ListPendingResponse {
  repeated Decision decisions = 1;
  int32 total = 2;
}

message GetDecisionRequest {
  string decision_id = 1;
}

message GetDecisionResponse {
  Decision decision = 1;
}

message CreateDecisionRequest {
  string question = 1;                    // The prompt/question for the human
  string context = 2;                     // Additional context for the decision
  repeated DecisionOption options = 3;    // Available options to choose from
  AgentAddress requested_by = 4;          // Agent requesting the decision
  Urgency urgency = 5;                    // How urgent is this decision
  repeated string blockers = 6;           // Work IDs blocked by this decision
  string parent_bead = 7;                 // Optional parent bead ID for hierarchy
  string predecessor_id = 8;              // Predecessor decision ID for chaining
}

message CreateDecisionResponse {
  Decision decision = 1;                  // The created decision with assigned ID
}

message ResolveRequest {
  string decision_id = 1;
  int32 chosen_index = 2;  // 1-indexed option number
  string rationale = 3;    // Explanation for the choice
}

message ResolveResponse {
  Decision decision = 1;
}

message CancelRequest {
  string decision_id = 1;
  string reason = 2;
}

message CancelResponse {}

message WatchDecisionsRequest {
  Urgency min_urgency = 1;
}

// Urgency levels for decisions
enum Urgency {
  URGENCY_UNSPECIFIED = 0;
  URGENCY_LOW = 1;
  URGENCY_MEDIUM = 2;
  URGENCY_HIGH = 3;
}

// A decision point requiring human input
message Decision {
  string id = 1;
  string question = 2;
  string context = 3;
  repeated DecisionOption options = 4;
  int32 chosen_index = 5;        // 0 = pending, 1-indexed when resolved
  string rationale = 6;          // Set after resolution
  AgentAddress requested_by = 7;
  google.protobuf.Timestamp requested_at = 8;
  string resolved_by = 9;
  google.protobuf.Timestamp resolved_at = 10;
  Urgency urgency = 11;
  repeated string blockers = 12; // Work IDs blocked by this decision
  bool resolved = 13;
  bool cancelled = 14;
  string predecessor_id = 15;    // Predecessor decision ID for chaining
  string parent_bead = 16;       // Parent bead ID (e.g., epic) for hierarchy/routing
  string parent_bead_title = 17; // Parent bead title for channel derivation
}

// An option in a decision
message DecisionOption {
  string label = 1;
  string description = 2;
  bool recommended = 3;
  string bead_id = 4;  // Optional bead ID for auto-assign when this option is selected
}
