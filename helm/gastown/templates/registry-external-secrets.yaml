{{- if .Values.registrySecrets }}
{{- if .Values.registrySecrets.enabled }}
{{- $storeName := .Values.registrySecrets.secretStoreName | default "aws-secretsmanager" }}
{{- $storeKind := .Values.registrySecrets.secretStoreKind | default "ClusterSecretStore" }}
{{- $refreshInterval := .Values.registrySecrets.refreshInterval | default "1h" }}
{{- range $name, $reg := .Values.registrySecrets.registries }}
{{- if and $reg.enabled $reg.remoteRef }}
---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: {{ $name }}-auth
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "gastown.labels" $ | nindent 4 }}
spec:
  refreshInterval: {{ $refreshInterval }}
  secretStoreRef:
    kind: {{ $storeKind }}
    name: {{ $storeName }}
  target:
    name: {{ $name }}
    creationPolicy: Owner
    deletionPolicy: Retain
    template:
      type: kubernetes.io/dockerconfigjson
      metadata: {}
      data:
        .dockerconfigjson: |
          {
            "auths": {
              {{- $first := true }}
              {{- range $host := $reg.hosts }}
              {{- if not $first }},{{ end }}
              "{{ $host }}": {
                "username": "{{`{{ .username }}`}}",
                "password": "{{`{{ .password }}`}}",
                "auth": "{{`{{ (printf "%s:%s" .username .password) | b64enc }}`}}"
              }
              {{- $first = false }}
              {{- end }}
            }
          }
  data:
    - secretKey: username
      remoteRef:
        key: {{ $reg.remoteRef }}
        property: {{ $reg.usernameProperty | default "username" }}
    - secretKey: password
      remoteRef:
        key: {{ $reg.remoteRef }}
        property: {{ $reg.passwordProperty | default "password" }}
{{- end }}
{{- end }}
{{- end }}
{{- end }}
