suite: ExternalSecret tests
templates:
  - templates/external-secret.yaml
tests:
  - it: does not render when externalSecrets disabled
    set:
      externalSecrets.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: does not render when git credentials not configured
    set:
      externalSecrets.enabled: true
    asserts:
      - hasDocuments:
          count: 0

  - it: renders git credentials ExternalSecret when configured
    set:
      externalSecrets.enabled: true
      externalSecrets.gitCredentials.enabled: true
      externalSecrets.gitCredentials.remoteRef: "gastown/git-credentials"
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ExternalSecret
        documentIndex: 0
      - equal:
          path: spec.secretStoreRef.kind
          value: ClusterSecretStore
        documentIndex: 0
      - equal:
          path: spec.secretStoreRef.name
          value: "aws-secretsmanager"
        documentIndex: 0
      - equal:
          path: spec.refreshInterval
          value: "15m"
        documentIndex: 0
      - equal:
          path: spec.data[0].remoteRef.property
          value: "username"
        documentIndex: 0
      - equal:
          path: spec.data[1].remoteRef.property
          value: "token"
        documentIndex: 0

  - it: does not render git credentials when disabled
    set:
      externalSecrets.enabled: true
      externalSecrets.gitCredentials.enabled: false
    asserts:
      - hasDocuments:
          count: 0

  - it: renders with gastown-test values
    values:
      - ../values/gastown-test.yaml
    asserts:
      - hasDocuments:
          count: 1
      - isKind:
          of: ExternalSecret
        documentIndex: 0

  - it: uses correct target secret name
    set:
      externalSecrets.enabled: true
      externalSecrets.gitCredentials.enabled: true
      externalSecrets.gitCredentials.remoteRef: "gastown/git-credentials"
    asserts:
      - equal:
          path: spec.target.name
          value: RELEASE-NAME-agent-pod-git-credentials
        documentIndex: 0
      - equal:
          path: spec.target.creationPolicy
          value: Owner
        documentIndex: 0
